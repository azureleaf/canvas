<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <title>タートルグラフィックス</title>
        <script>
        let canvas,context;
        let ox,oy,angle,color,currentNode;
        let opData=new Array();
        let index,timer=null;

        const init=() =>{
            //キャンバスの取得
            canvas=document.getElementById("ground");
            context=canvas.getContext("2d");
            //初期化
            reset(true);
        }

        const reset=resetList=>{
            //グラフィックの初期化
            context.clearRect(0,0,canvas.width,canvas.height);
            ox=canvas.width/2;
            oy=canvas.height/2;
            angle=0;
            color="#000000";
            //リストの初期化
            if (resetList){
                opData=[];
                document.getElementById("list").innerHTML="";
                currentNode=document.getElementById("list");
                drawMark();
            }
        }

        const drawMark=()=>{
            //マークの描画
            context.save();
            context.translate(ox,oy);
            context.rotate(angle);
            context.fillStyle=color;
            context.beginPath();
            context.moveTo(20,0);
            context.lineTo(0,-10);
            context.lineTo(0,10);
            context.fill();
            context.restore();
        }
        
        const forward=d=>{
            //進む
            const x=ox+d*Math.cos(angle);
            const y=oy+d*Math.sin(angle);
            context.strokeStyle=color;
            context.beginPath();
            context.moveTo(ox,oy);
            context.lineTo(x,y);
            context.stroke();
            ox=x;
            oy=y;
        }

        const rotate=a=>{
            //回転
            angle+=a*Math.PI/180;
        }

        const setColor=c=>{
            //色の変更
            color=c;
        }

        const addOp=opType=>{
            //命令を追加
            const op=document.createElement("div");
            op.className=opType;
            const input=document.createElement("input")
            input.type="number";
            input.value=0;
            input.onchange=setOpData;
            if(opType=="forward")op.innerText="進む(距離):";
            if(opType=="rotate")op.innerText="回転(角度):";
            if(opType=="color"){
                op.innerText="色:";
                input.type="color";
                input.value="#000000";
            }
            if(opType=="loop"){
                op.innerText="繰り返し:";
                input.value=1;
            }
            op.appendChild(input);
            currentNode.appendChild(op);
            //繰り返し開始(ノードの移動)
            if(opType=="loop"){
                currentNode=document.createElement("div");
                currentNode.className="black";
                op.appendChild(currentNode);
            }
            setOpData();
        }

        const endLoop=()=>{
            //繰り返し終了(ノードの移動)
            if (currentNode != document.getElementById("list")){
                currentNode = currentNode.parentNode.parentNode;
            }
        }

        const setOpData = () => {
            //命令を格納
            opData=[];
            setOp(document.getElementById("list").children);
            //実行
            run(1);
        }

        const setOp = ops => {
            //loop以外の命令を配列に格納
            for(const op of ops){
                const val=op.children[0].value;
                if(op.className=="loop"){
                    for(let i=0;i<val; i++){
                        setOp(op.children[1].children);
                    }
                } else {
                    opData.push({"op":op.className,"value":val});
                }
            }
        }

        const run = t => {
            //実行開始
            if(timer !=null) clearInterval(timer);
            if(opData.length>0){
                reset(false);
                index=0;
                timer = setInterval(runOp,t);
            }
        }

        const runOp = () => {
            //命令を実行
            const data=opData[index];
            if (data.op == "forward") forward(data.value);
            if (data.op == "rotate") rotate(data.value);
            if (data.op == "color") setColor(data.value);
            index++;
            //実行終了
            if(index>=opData.length){
                clearInterval(timer);
                timer=null;
                drawMark();
            }
        }
        </script>
<style>
canvas{
    float:left;
    border:thin solid #669966;
}
input [type="number"] {width:50px;}
#list{float:left;}
#list div{
    width:200px;
    padding:5px;
    margin:5px;
    color:#ffffff;
}
.forward{background-color:#990000;}
.rotate{background-color:#009900;}
.color{background-color:#996600;}
.loop{background-color:#660066;}
.block{background-color:#ffffff;}
</style>
    </head>
<body onload="init()">
    <p>タートルグラフィックス</p>
    <input type="button" value="クリア" onclick="reset(true)">
    <input type="button" value="実行" onclick="run(100)">
    <input type="button" value="進む" onclick="addOp('forward')">
    <input type="button" value="回転" onclick="addOp('rotate')">
    <input type="button" value="色変更" onclick="addOp('color')">
    <input type="button" value="繰り返し開始" onclick="addOp('loop')">
    <input type="button" value="繰り返し終了" onclick="endLoop()">
    <hr>
    <canvas id="ground" width="800" height="600"></canvas>
    <div id="list"></div>
</body>
</html>