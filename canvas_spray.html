<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>スプレーアート</title>
<script>
var canvas, contex, canvasRect;//描画用キャンバス
var canvasMask, contexMask;//マスク用キャンバス
var mouseDown = false;//マウスボタンが押されたか?
var maskType = "none";//マスクの種類(circle/rect/triangle/none)
var mx1, my1, mx2, my2, mr;//マスクの座標、半径

function init(){
canvas = document.getElementById("image");//描画用キャンバスのID(176秒)
context = canvas.getContext("2d"),
canvasMask = document.getElementById("mask");//マスク用キャンバスのID(177行)
contextMask = canvasMask.getContext("2d");
canvasRect = canvas.getBoundingClientRect();//描画用キャンバスの矩形情報を取得

initCanvas();
}


function initCanvas () {

context.fillStyle = "#FFFFFF";//塗りつぶしの色は白
context.fillRect(0, 0, canvas.width, canvas.height);//描画用キャンバスの横幅、高さ
clearMask();

function clearMask(){
//マスク用キャンバスのクリア
contextMask.clearRect(0, 0, canvasMask.width, canvasMask.height);
maskType = "none";
}

function startDraw(event) {

mouseDown = true;
var x = event.clientX - canvasRect.left;//描画用キャンバス内のマウスカーソルの座標を取得
var y = event.clientY - canvasRect.top;

if (document.getElementById("spray").checked){//「スプレー」が選択されている時
drawSpray (x, y);
} else {

mx1=x;
my1=y;
}
}

function draw(event){
	//マウスボタンが押されている時に描画
	if(mouseDown){// マウスボタンが押されている時
		var x=event.clientX-canvasRect.left;
		var y=event.clientY-canvasRect.top;
		//スプレーの描画/マスクの終点＋描画
		if(document.getElementById("spray").checked){
			drawSpray(x,y);
		}else{
		mx2=x;
		my2=y;
		drawMask();
		}
		}
	}
}

function drawSpray(x,y){
	//マスクを作成
	context.save();//描画用キャンバスを保存
	context.beginPath();//マスク用のパスを作成開始
	context.rect(0,0,canvas.width,canvas.height);//描画キャンバスと同じサイズのパスを作成
	if(maskType=="circle"){
		context.arc(mx1,my1,mr,0,Math.PI*2);//円形のパスを作成
	} else if (maskType=="rect"){
		context.rect(mx1,my1,mx2-mx1,my2-my1)//矩形のパスを作成
	} else if(maskType=="triangle"){
		context.moveTo(mx1,my1);//三角形のパスを作成
		context.lineTo(mx2,my2);
		context.lineTo(2*mx1-mx2,my2);
	}
	context.closePath();//パスを閉じる
	context.clip("evenodd")//パスをクリッピング領域に変換
	//サイズ、色の取得
	var size=document.getElementById("size").value;//「半径」調整スライダーのID(173行)
	var color=document.getElementById("color").value;//スプレーの色選択フォームのID(172行)

	var r=parseInt(color.substring(1,3),16);//色の値をRGBに分解
	var g=parseInt(color.substring(3,5),16);
	var b=parseInt(color.substring(5,7),16);
	var a=document.getElementById("a").value;//「濃さ」調整スライダーのID(174行)
	//スプレーの描画
	var grad=context.createRadialGradient(x,y,1,x,y,size);

	grad.addColorStop(0.0,"rgba("+r+","+g+","+b+","+a+")");
	grad.addColorStop(0.6,"rgba("+r+","+g+","+b+",0.1)");
	grad.addColorStop(1.0,"rgba("+r+","+g+","+b+",0)");
	context.fillStyle=grad;
	context.beginPath();
	context.arc(x,y,size,0,Math.PI*2);//指定したグラデーションで円を描く
	context.fill();
	context.restore();//描画用キャンバスを元に戻す

}

function drawMask(){
	//マスクの描画
	clearMask();
	contextMask.strokeStyle="#0000FF";//マスクを表す線の色は青
	contextMask.beginPath();
	if(document.getElementById("m_circle").checked){//「マスク(円)」が選択されている時
		//円
		maskType="circle";
		mr=Math.sqrt(Math.pow(mx1-mx2,2)+Math.pow(my1-my2,2));//半径を計算
		contextMask.arc(mx1,my1,mr,0,Math.PI*2);
	} else if(document.getElementById("m_triangle").checked){//「マスク(矩形)」が選択されている時
		//線1
		maskType="rect";
		contextMask.rect(mx1,my1,mx2-mx1,my2-my1);
	} else if (document.getElementById("m_triangle").checked){//「マスク(三角形)」が選択されている時
		//線2
		maskType="triangle";
		contextMask.moveTo(mx1,my1);
		contexMask.lineTo(mx2,my2);
		contextMask.lineTo(2*mx1-mx2,my2);
	}
	contextMask.closePath();
	contextMask.stroke();//パスの線を描く
}

function endDraw(event){
	//マウスボタンが放された
	mouseDown=false;
}

function saveCanvas(){
	var filename=window.prompt("ファイル名を入力して下さい","spray.png");//デフォルトのファイル名
	if (filename!=null){
		if (canvas.msToBlob){
			//msToBlobを使用できるブラウザー//IEの場合

			var blob=canvas.msToBlob();
			window.navigator.msSaveBlob(blob.filename);
		} else {
			//それ以外のブラウザ
			var a =document.createElement("a");//「a」要素を作成
			a.href=canvas.toDataURL("image/png");//リンク先に画像のURLを保存
		a.download=filename;
		document.body.appendChild(a);
		a.click();
		document.body.appendChild(a);
		a.click();
		document.body.removeChild(a);
		}
	}
}
</script>
<style>
	div{position: relative;}
	#mask{
		position: absolute;
		top:0;
		left:0;
		border: thin solid #cccccc;
	}
</style>
</head>
<body onload="init()">
	<!-- このhtmlファイルを読み込んだ時にinit()関数を実行する -->
	<p>スプレーアート</p>
	<input type="button" value="新規作成" onclick="initCanvas()"><!-- 新規作成、保存ボタン -->
	<input type="button" value="保存" onclick="saveCanvas()"><hr>

	<label><input type="radio" id="spray" name="s_m" checked>スプレー</label><!-- マスクの選択ラジオボタン -->
	<label><input type="radio" id="m_circle" name="s_m" >マスク(円)</label>
	<label><input type="radio" id="m_rect" name="s_m" >マスク(矩形)</label>
	<label><input type="radio" id="m_triangle" name="s_m" >マスク(三角形)</label>

	<input type="button" value="マスクのクリア" onclick="clearMask()"><hr><!-- マスクのクリアボタン -->
	スプレーの色:<input type="color" id="color" value="#000000"><!-- スプレーの色選択フォーム -->
	半径:<input type="range" id="size" value="50" min="2" max="200">
<!-- 	半径/濃さ調整スライダー -->
	濃さ:<input type="range" id="a" value="1" min="0.1" max="1.0" step="0.1"><hr>
<div>
	<canvas id="image" width="800" height="600"></canvas>
	<canvas id="mask" width="800" height="600"
	onmousedown="startDraw(event)" onmousemove="draw(event)" onmouseup="endDraw(event)"
	onmouseleave="endDraw(event)">
	</canvas>
</div>
</body>
</html>
